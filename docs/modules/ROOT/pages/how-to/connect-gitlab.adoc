= Connect GitLab to {product}

image:logos/gitlab.svg[role="related thumb right",alt="GitLab logo",width=120,height=120] This page explains how to connect your GitLab project to {product} for your GitOps operations.

This integration has two major aspects:

. Configuring {product} as a Kubernetes cluster for your GitLab project.
. Connecting {product} to access your GitLab project's container registry.

== Prerequisites

For this guide, it's assumed that:

* You have a GitLab project (either on https://gitlab.com or in a private instance).
* You are logged in to your {product} project using the `oc login` command.

== Configuring {product} as a Kubernetes cluster in GitLab

To configure your {product} project as a Kubernetes cluster in GitLab, follow the steps that are outlined in more detail below:

. Create a service account in your project.
. Add an elevated role to this service account.
. Create a local `KUBECONFIG` variable and login to your OpenShift cluster.
. Create a variable named `KUBECONFIG` in the GitLab settings.

The following commands show the steps in detail:

[source,shell]
----
oc project [PROJECT-NAME]
oc create serviceaccount gitlab-ci
oc policy add-role-to-user admin -z gitlab-ci --rolebinding-name gitlab-ci
----

Create a local KUBECONFIG variable and login to your OpenShift cluster using the gitlab-ci service account:

[source,shell]
----
TOKEN=$(oc sa get-token gitlab-ci)
export KUBECONFIG=gitlab-ci.kubeconfig
oc login --server=$OPENSHIFT_API_URL --token=$TOKEN
unset KUBECONFIG
----

You should now have a file named `gitlab-ci.kubeconfig` in your current working directory. Copy its contents and create a variable named `KUBECONFIG` in the GitLab settings with the value of the file (that's under menu:Settings[CI/CD > Variables > Expand > Add Variable]). Remember to set the "environment" scope for the variable and to disable any previous Kubernetes integration, as the `KUBECONFIG` variable might collide with this new variable.

== Connecting {product} to the GitLab Container Registry

To configure your GitLab container registry in your {product} project, follow these steps:

. Create a deploy token in GitLab.
. Create a secret in {product}.
. Specify the secret in your deployment.

=== Create a Deploy Token in GitLab

Follow these steps to create a new deploy token in your GitLab project:

. In your GitLab project, select and expand the menu:Settings[Repository > Deploy Tokens] item, and scroll to the bottom to select the btn:[Connect existing cluster] button.
. Provide a name, an (optional) expiration date, and a an (optional) username.
. Check the `read_registry` checkbox.
. Click the btn:[Create deploy token] button.
. Copy the token immediately; it won't be shown ever again.

image::gitlab-registry.png[]

NOTE: If no name is provided, GitLab provides a default username of the form `gitlab+deploy-token-{n}`.

=== Create a Secret

The `oc` command below creates a secret with the required values.
Replace the `--docker-username` and `--docker-password` values with those used in the previous step.
Also replace the `--docker-server` parameter with the URL of your own GitLab instance if you have one.

[source,shell]
----
oc create secret docker-registry gitlab-pull-secret \
	--docker-server=https://registry.gitlab.com \
	--docker-username=your-token-username \   # <1>
	--docker-password=xXXxXxxXXXxXXXxXXXxX    # <2>
----
<1> The username is the same one entered in the GitLab token form shown above in step 2, or else the default name generated by GitLab.
<2> The value of the token, copied in step 5 above.

=== Specify the Secret in your Deployment

Use the YAML below to specify your new secret.

[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-name
spec:
  template:
    spec:
      imagePullSecrets:
        - name: gitlab-pull-secret # <1>
      ...
----
<1> Name of the secret created in the previous step.
